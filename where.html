<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLB Odds Real-Time Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.running {
            background: #4ade80;
        }
        
        .status-indicator.stopped {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #f1f5f9;
            font-size: 18px;
        }
        
        .chart-container {
            grid-column: 1 / -1;
            height: 400px;
        }
        
        .data-table {
            grid-column: 1 / -1;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }
        
        .change-positive {
            color: #4ade80;
        }
        
        .change-negative {
            color: #ef4444;
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèüÔ∏è MLB Odds Real-Time Tracker</h1>
            <p>Continuous monitoring with 30-second intervals</p>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Stopped</span>
            </div>
            <div class="status-item">
                <span>‚è∞ Next Update: <span id="nextUpdate">--</span></span>
            </div>
            <div class="status-item">
                <span>üìä Total Records: <span id="totalRecords">0</span></span>
            </div>
            <div class="status-item">
                <span>üîÑ Updates: <span id="updateCount">0</span></span>
            </div>
            <div class="status-item">
                <span>üì§ GitHub: <span id="githubStatus">Disconnected</span></span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="startTracking()">‚ñ∂Ô∏è Start Tracking</button>
            <button class="btn btn-danger" onclick="stopTracking()">‚èπÔ∏è Stop Tracking</button>
            <button class="btn btn-success" onclick="syncToGitHub()">üì§ Sync to GitHub</button>
            <button class="btn btn-primary" onclick="exportData()">üíæ Export Data</button>
        </div>
        
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-value" id="activeGames">0</div>
                <div class="stat-label">Active Games</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalSportsbooks">0</div>
                <div class="stat-label">Sportsbooks</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="priceChanges">0</div>
                <div class="stat-label">Price Changes</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="averageChange">0%</div>
                <div class="stat-label">Avg Change</div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card chart-container">
                <h3>üìà Live Odds Tracking</h3>
                <canvas id="oddsChart"></canvas>
            </div>
            
            <div class="card data-table">
                <h3>üîÑ Recent Price Changes</h3>
                <table id="changesTable">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Team</th>
                            <th>Sbook</th>
                            <th>Old</th>
                            <th>New</th>
                            <th>Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="6" style="text-align: center; opacity: 0.6;">No data yet</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <h3>üìã Activity Log</h3>
                <div class="log-container" id="logContainer">
                    <div>System initialized. Ready to start tracking...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            UPDATE_INTERVAL: 30000, // 30 seconds
            GITHUB_TOKEN: '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',
            GITHUB_USERNAME: 'APNPAPNU',
            REPO_NAME: 'Apnubets2',
            GITHUB_EMAIL: 'jcpgraphicdesign@gmail.com',
            GITHUB_NAME: 'apnu',
            ODDS_API_URL: 'https://oddsjam.com/api/backend/oddscreen/v2/game/data'
        };
        
        // Global state
        let isTracking = false;
        let updateInterval = null;
        let nextUpdateTimeout = null;
        let oddsData = [];
        let priceChanges = [];
        let updateCount = 0;
        let chart = null;
        let countdownInterval = null;
        
        // Initialize chart
        function initializeChart() {
            const ctx = document.getElementById('oddsChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        x: {
                            ticks: { color: 'rgba(255, 255, 255, 0.8)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: 'rgba(255, 255, 255, 0.8)' }
                        }
                    }
                }
            });
        }
        
        // Fetch MLB odds from OddsJam API (converted from Python)
        async function fetchMLBOdds(state = "TN") {
            const params = new URLSearchParams({
                sport: "baseball",
                league: "mlb",
                state: state,
                market_name: "moneyline",
                is_future: "0",
                game_status_filter: "All",
                show_paywall: "false",
                paywall: "false",
                premium: "false",
                subscription: "false"
            });
            
            const headers = {
                "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
                "Accept": "application/json, text/plain, */*",
                "Accept-Language": "en-US,en;q=0.9",
                "Accept-Encoding": "gzip, deflate, br",
                "Referer": "https://oddsjam.com/",
                "Origin": "https://oddsjam.com",
                "Connection": "keep-alive",
                "Sec-Fetch-Dest": "empty",
                "Sec-Fetch-Mode": "cors",
                "Sec-Fetch-Site": "same-origin"
            };
            
            try {
                const response = await fetch(`${CONFIG.ODDS_API_URL}?${params}`, {
                    method: 'GET',
                    headers: headers,
                    mode: 'cors'
                });
                
                if (response.ok) {
                    return await response.json();
                } else {
                    throw new Error(`API request failed with status: ${response.status}`);
                }
            } catch (error) {
                throw new Error(`Error making API request: ${error.message}`);
            }
        }
        
        // Parse odds data (converted from Python)
        function parseOddsData(data) {
            const oddsRecords = [];
            
            if (!data) {
                log("No data found in API response");
                return oddsRecords;
            }
            
            log(`API Response Keys: ${Object.keys(data).join(', ')}`);
            
            let gamesData = null;
            if (data.data) {
                gamesData = data.data;
            } else if (data.games) {
                gamesData = data.games;
            } else {
                log("Could not find games data in response");
                return oddsRecords;
            }
            
            log(`Found ${gamesData.length} game entries`);
            
            gamesData.forEach(gameData => {
                if (gameData.rows) {
                    // Process rows structure
                    const gameId = gameData.game_id || "Unknown";
                    
                    gameData.rows.forEach(row => {
                        const teamInfo = row.display?.Moneyline || {};
                        const teamName = teamInfo.team_name || teamInfo.title || "Unknown";
                        const homeOrAway = row.home_or_away || "Unknown";
                        const oddsData = row.odds || {};
                        
                        Object.entries(oddsData).forEach(([sportsbook, oddsList]) => {
                            oddsList.forEach(oddsEntry => {
                                oddsRecords.push({
                                    game_id: gameId,
                                    team_name: teamName,
                                    home_or_away: homeOrAway,
                                    sportsbook: sportsbook,
                                    price: oddsEntry.price || "N/A",
                                    market_name: oddsEntry.market_name || "N/A",
                                    bet_name: oddsEntry.bet_name || "N/A",
                                    timestamp: new Date().toISOString()
                                });
                            });
                        });
                    });
                } else {
                    // Process direct game data structure
                    const gameId = gameData.game_id || "Unknown";
                    const teamInfo = gameData.display?.Moneyline || {};
                    const teamName = teamInfo.team_name || teamInfo.title || "Unknown";
                    const homeOrAway = gameData.home_or_away || "Unknown";
                    const oddsDataDirect = gameData.odds || {};
                    
                    Object.entries(oddsDataDirect).forEach(([sportsbook, oddsList]) => {
                        oddsList.forEach(oddsEntry => {
                            oddsRecords.push({
                                game_id: gameId,
                                team_name: teamName,
                                home_or_away: homeOrAway,
                                sportsbook: sportsbook,
                                price: oddsEntry.price || "N/A",
                                market_name: oddsEntry.market_name || "N/A",
                                bet_name: oddsEntry.bet_name || "N/A",
                                timestamp: new Date().toISOString()
                            });
                        });
                    });
                }
            });
            
            return oddsRecords;
        }
        
        // Update odds data
        async function updateOddsData() {
            try {
                log('üîÑ Fetching new odds data...');
                const rawData = await fetchMLBOdds();
                const newData = parseOddsData(rawData);
                
                if (newData.length === 0) {
                    log('‚ö†Ô∏è No odds data found in response');
                    return;
                }
                
                // Compare with previous data to find changes
                if (oddsData.length > 0) {
                    const changes = detectPriceChanges(oddsData[oddsData.length - 1], newData);
                    if (changes.length > 0) {
                        priceChanges.push(...changes);
                        updateChangesTable();
                        log(`üìä Found ${changes.length} price changes`);
                    }
                }
                
                oddsData.push({
                    timestamp: new Date(),
                    data: newData
                });
                
                // Keep only last 50 data points for performance
                if (oddsData.length > 50) {
                    oddsData = oddsData.slice(-50);
                }
                
                updateChart();
                updateStats();
                updateCount++;
                document.getElementById('updateCount').textContent = updateCount;
                document.getElementById('totalRecords').textContent = newData.length;
                
                log(`‚úÖ Updated successfully (${newData.length} records)`);
                
            } catch (error) {
                log(`‚ùå Error updating data: ${error.message}`);
            }
        }
        
        // Detect price changes
        function detectPriceChanges(oldDataSet, newData) {
            if (!oldDataSet || !oldDataSet.data) return [];
            
            const changes = [];
            const oldData = oldDataSet.data;
            
            newData.forEach(newRecord => {
                const oldRecord = oldData.find(old => 
                    old.game_id === newRecord.game_id &&
                    old.team_name === newRecord.team_name &&
                    old.sportsbook === newRecord.sportsbook &&
                    old.home_or_away === newRecord.home_or_away
                );
                
                if (oldRecord && parseFloat(oldRecord.price) !== parseFloat(newRecord.price)) {
                    const oldPrice = parseFloat(oldRecord.price);
                    const newPrice = parseFloat(newRecord.price);
                    
                    if (!isNaN(oldPrice) && !isNaN(newPrice)) {
                        changes.push({
                            timestamp: new Date(),
                            game_id: newRecord.game_id,
                            team_name: newRecord.team_name,
                            sportsbook: newRecord.sportsbook,
                            home_or_away: newRecord.home_or_away,
                            old_price: oldPrice,
                            new_price: newPrice,
                            change: newPrice - oldPrice
                        });
                    }
                }
            });
            
            return changes;
        }
        
        // Update chart with latest odds data
        function updateChart() {
            if (!chart || oddsData.length === 0) return;
            
            const labels = oddsData.map(d => d.timestamp.toLocaleTimeString());
            const datasets = new Map();
            
            // Group by team and sportsbook for chart lines
            oddsData.forEach((dataPoint, index) => {
                dataPoint.data.forEach(record => {
                    if (record.price && !isNaN(parseFloat(record.price))) {
                        const key = `${record.team_name} (${record.sportsbook})`;
                        
                        if (!datasets.has(key)) {
                            datasets.set(key, {
                                label: key,
                                data: new Array(oddsData.length).fill(null),
                                borderColor: getRandomColor(),
                                backgroundColor: 'transparent',
                                tension: 0.1
                            });
                        }
                        
                        datasets.get(key).data[index] = parseFloat(record.price);
                    }
                });
            });
            
            // Limit to top 10 most active lines for readability
            const sortedDatasets = Array.from(datasets.values())
                .sort((a, b) => b.data.filter(v => v !== null).length - a.data.filter(v => v !== null).length)
                .slice(0, 10);
            
            chart.data.labels = labels;
            chart.data.datasets = sortedDatasets;
            chart.update('none');
        }
        
        // Update changes table
        function updateChangesTable() {
            const tbody = document.querySelector('#changesTable tbody');
            const recentChanges = priceChanges.slice(-20).reverse(); // Last 20 changes, newest first
            
            if (recentChanges.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.6;">No changes yet</td></tr>';
                return;
            }
            
            tbody.innerHTML = recentChanges.map(change => `
                <tr>
                    <td>${change.timestamp.toLocaleTimeString()}</td>
                    <td>${change.team_name}</td>
                    <td>${change.sportsbook}</td>
                    <td>${change.old_price > 0 ? '+' : ''}${change.old_price}</td>
                    <td>${change.new_price > 0 ? '+' : ''}${change.new_price}</td>
                    <td class="${change.change > 0 ? 'change-positive' : 'change-negative'}">
                        ${change.change > 0 ? '+' : ''}${change.change.toFixed(0)}
                    </td>
                </tr>
            `).join('');
        }
        
        // Update summary statistics
        function updateStats() {
            if (oddsData.length === 0) return;
            
            const latestData = oddsData[oddsData.length - 1].data;
            const uniqueGames = new Set(latestData.map(r => r.game_id)).size;
            const uniqueSportsbooks = new Set(latestData.map(r => r.sportsbook)).size;
            const totalChanges = priceChanges.length;
            
            let avgChange = 0;
            if (priceChanges.length > 0) {
                const recentChanges = priceChanges.slice(-10);
                avgChange = recentChanges.reduce((sum, c) => sum + Math.abs(c.change), 0) / recentChanges.length;
            }
            
            document.getElementById('activeGames').textContent = uniqueGames;
            document.getElementById('totalSportsbooks').textContent = uniqueSportsbooks;
            document.getElementById('priceChanges').textContent = totalChanges;
            document.getElementById('averageChange').textContent = avgChange.toFixed(1) + '%';
        }
        
        // Start tracking
        function startTracking() {
            if (isTracking) return;
            
            isTracking = true;
            document.getElementById('statusIndicator').className = 'status-indicator running';
            document.getElementById('statusText').textContent = 'Running';
            
            log('üöÄ Starting continuous tracking...');
            
            // Initial update
            updateOddsData();
            
            // Set up interval
            updateInterval = setInterval(updateOddsData, CONFIG.UPDATE_INTERVAL);
            
            // Start countdown
            startCountdown();
        }
        
        // Stop tracking
        function stopTracking() {
            if (!isTracking) return;
            
            isTracking = false;
            document.getElementById('statusIndicator').className = 'status-indicator stopped';
            document.getElementById('statusText').textContent = 'Stopped';
            document.getElementById('nextUpdate').textContent = '--';
            
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            log('‚èπÔ∏è Tracking stopped');
        }
        
        // Start countdown timer
        function startCountdown() {
            let secondsLeft = CONFIG.UPDATE_INTERVAL / 1000;
            
            countdownInterval = setInterval(() => {
                if (secondsLeft <= 0) {
                    secondsLeft = CONFIG.UPDATE_INTERVAL / 1000;
                }
                
                document.getElementById('nextUpdate').textContent = `${secondsLeft}s`;
                secondsLeft--;
            }, 1000);
        }
        
        // Sync to GitHub
        async function syncToGitHub() {
            if (oddsData.length === 0) {
                log('‚ùå No data to sync');
                return;
            }
            
            try {
                log('üì§ Syncing to GitHub...');
                document.getElementById('githubStatus').textContent = 'Syncing...';
                
                // Prepare data for upload
                const jsonData = JSON.stringify({
                    timestamp: new Date().toISOString(),
                    oddsData: oddsData,
                    priceChanges: priceChanges,
                    summary: {
                        totalUpdates: updateCount,
                        totalRecords: oddsData.reduce((sum, d) => sum + d.data.length, 0),
                        totalChanges: priceChanges.length
                    }
                }, null, 2);
                
                const filename = `mlb_odds_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                
                // GitHub API call to create/update file
                const response = await fetch(`https://api.github.com/repos/${CONFIG.GITHUB_USERNAME}/${CONFIG.REPO_NAME}/contents/${filename}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `Update MLB odds data - ${new Date().toLocaleString()}`,
                        content: btoa(unescape(encodeURIComponent(jsonData))),
                        committer: {
                            name: CONFIG.GITHUB_NAME,
                            email: CONFIG.GITHUB_EMAIL
                        }
                    })
                });
                
                if (response.ok) {
                    document.getElementById('githubStatus').textContent = 'Connected';
                    log('‚úÖ Successfully synced to GitHub');
                } else {
                    throw new Error(`GitHub API error: ${response.status}`);
                }
                
            } catch (error) {
                document.getElementById('githubStatus').textContent = 'Error';
                log(`‚ùå GitHub sync failed: ${error.message}`);
            }
        }
        
        // Export data as JSON
        function exportData() {
            if (oddsData.length === 0) {
                log('‚ùå No data to export');
                return;
            }
            
            const exportData = {
                timestamp: new Date().toISOString(),
                oddsData: oddsData,
                priceChanges: priceChanges,
                summary: {
                    totalUpdates: updateCount,
                    totalRecords: oddsData.reduce((sum, d) => sum + d.data.length, 0),
                    totalChanges: priceChanges.length
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mlb_odds_export_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üíæ Data exported successfully');
        }
        
        // Logging function
        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // Keep only last 100 log entries
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }
        
        // Generate random color for chart lines
        function getRandomColor() {
            const colors = [
                '#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0',
                '#9966ff', '#ff9f40', '#ff6384', '#c9cbcf', '#4bc0c0'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            log('üéØ MLB Odds Tracker initialized');
            log('üìù Using JSON format for better data storage');
            log('üîÑ Ready to start 30-second interval tracking');
            log('üì§ GitHub integration configured');
        });
        
        // Auto-start on page load (optional)
        // setTimeout(startTracking, 2000);
    </script>
</body>
</html>
